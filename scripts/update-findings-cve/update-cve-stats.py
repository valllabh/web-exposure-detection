#!/usr/bin/env python3

"""
Update CVE statistics for findings.json using cvemap.
This script queries cvemap for CVE data and updates findings.json with security stats.
Usage: python3 scripts/update-findings-cve/update-cve-stats.py
"""

import json
import subprocess
import sys
import re
import time
from datetime import datetime, timezone
from pathlib import Path

FINDINGS_FILE = Path("pkg/webexposure/findings.json")


def check_dependencies():
    """Check if required tools are installed."""
    try:
        subprocess.run(["cvemap", "-version"], capture_output=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("Error: cvemap is not installed. Install it from: https://github.com/projectdiscovery/cvemap")
        sys.exit(1)


def normalize_product_name(display_name):
    """Normalize product names for cvemap queries."""
    name = display_name.lower()

    # Remove common suffixes
    name = re.sub(r'\.js$', '', name, flags=re.IGNORECASE)
    name = re.sub(r'\.net$', '', name, flags=re.IGNORECASE)
    name = re.sub(r' framework$', '', name, flags=re.IGNORECASE)
    name = re.sub(r' auth$', '', name, flags=re.IGNORECASE)
    name = re.sub(r' api$', '', name, flags=re.IGNORECASE)
    name = re.sub(r' spec$', '', name, flags=re.IGNORECASE)
    name = re.sub(r' collection$', '', name, flags=re.IGNORECASE)
    name = re.sub(r'^sign in with ', '', name, flags=re.IGNORECASE)

    # Replace spaces with underscores
    name = name.replace(' ', '_')

    return name.strip()


def should_query_finding(slug):
    """Check if a finding should be queried for CVEs."""
    # Skip metadata and status findings
    if slug.startswith('page.') or slug.startswith('server.'):
        return False

    # Skip auth methods (these are features, not products with CVEs)
    if slug.startswith('auth.traditional.') or slug in ['auth.mfa', 'auth.passwordless']:
        return False

    # Skip domain patterns
    if slug == 'api.domain_pattern':
        return False

    return True


def get_cve_stats(product, slug):
    """Query cvemap for CVE statistics."""
    print(f"  Querying cvemap for: {product} (slug: {slug})...")

    try:
        # Query cvemap with JSON output and silent mode
        result = subprocess.run(
            ["cvemap", "-p", product, "-j", "-silent"],
            capture_output=True,
            text=True,
            timeout=30
        )

        # Get current timestamp in ISO 8601 format (UTC)
        timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

        # Parse JSON output
        if result.stdout.strip():
            try:
                cve_data = json.loads(result.stdout)

                if not cve_data:
                    print(f"    No CVEs found (checked: {timestamp})")
                    return {
                        "slug": slug,
                        "stats": {"critical": 0, "high": 0, "medium": 0, "low": 0, "total": 0},
                        "updated": timestamp
                    }

                # Count CVEs by severity
                critical = sum(1 for cve in cve_data if cve.get('severity') == 'critical')
                high = sum(1 for cve in cve_data if cve.get('severity') == 'high')
                medium = sum(1 for cve in cve_data if cve.get('severity') == 'medium')
                low = sum(1 for cve in cve_data if cve.get('severity') == 'low')
                total = critical + high + medium + low

                print(f"    Found {total} CVEs: critical={critical}, high={high}, medium={medium}, low={low}")

                return {
                    "slug": slug,
                    "stats": {
                        "critical": critical,
                        "high": high,
                        "medium": medium,
                        "low": low,
                        "total": total
                    },
                    "updated": timestamp
                }
            except json.JSONDecodeError:
                print(f"    Warning: Could not parse cvemap output for {product}")
                return None
        else:
            print(f"    No CVEs found (checked: {timestamp})")
            return {
                "slug": slug,
                "stats": {"critical": 0, "high": 0, "medium": 0, "low": 0, "total": 0},
                "updated": timestamp
            }

    except subprocess.TimeoutExpired:
        print(f"    Warning: cvemap query timed out for {product}")
        return None
    except Exception as e:
        print(f"    Warning: Error querying cvemap for {product}: {e}")
        return None


def main():
    print("Starting CVE statistics update...")
    print()

    # Check dependencies
    check_dependencies()

    # Load findings
    if not FINDINGS_FILE.exists():
        print(f"Error: {FINDINGS_FILE} not found")
        sys.exit(1)

    with open(FINDINGS_FILE, 'r') as f:
        findings = json.load(f)

    total_findings = len(findings)
    print(f"Total findings in file: {total_findings}")
    print()

    # Process each finding
    results = []
    count = 0
    processed = 0
    skipped = 0

    print("Processing findings...")
    for slug, finding in findings.items():
        count += 1
        display_name = finding.get('display_name', slug)
        print(f"[{count}/{total_findings}] Processing: {slug} - {display_name}")

        # Check if we should query this finding
        if not should_query_finding(slug):
            print("  Skipping (metadata/auth/domain pattern)")
            skipped += 1
            continue

        # Normalize product name
        product = normalize_product_name(display_name)

        # Skip if product name is too generic or empty
        if not product or product == '-':
            print("  Skipping (invalid product name)")
            skipped += 1
            continue

        # Get CVE stats
        stats = get_cve_stats(product, slug)
        if stats:
            results.append(stats)
            processed += 1

        # Small delay to avoid rate limiting
        time.sleep(0.5)

    print()
    print(f"Processed: {processed} findings")
    print(f"Skipped: {skipped} findings")
    print()

    if not results:
        print("No products queried (all findings were skipped)")
        return

    # Update findings with CVE statistics
    print("Updating findings.json with CVE statistics...")
    for result in results:
        slug = result['slug']
        if slug in findings:
            findings[slug]['security'] = {
                'cve': {
                    'stats': result['stats'],
                    'updated': result['updated']
                }
            }

    # Write updated findings back to file
    with open(FINDINGS_FILE, 'w') as f:
        json.dump(findings, f, indent=2, ensure_ascii=False)
        f.write('\n')  # Add trailing newline

    print()
    print("âœ“ CVE statistics updated successfully!")
    print()
    print("Summary:")
    for slug, finding in findings.items():
        if 'security' in finding and 'cve' in finding['security']:
            cve = finding['security']['cve']
            stats = cve['stats']
            print(f"{slug}: critical={stats['critical']}, high={stats['high']}, "
                  f"medium={stats['medium']}, low={stats['low']}, total={stats['total']} "
                  f"(updated: {cve['updated']})")


if __name__ == '__main__':
    main()
