#!/usr/bin/env python3

"""
Remove CVE and weaknesses data from findings where cve_applicable=false.

Since CVE data is not applicable for these findings (cloud services, auth methods, etc.),
we should remove any existing CVE/CWE data to avoid confusion.

Usage: python3 scripts/update-findings-cve/cleanup-inapplicable-cve-data.py
"""

import json
from pathlib import Path

FINDINGS_FILE = Path("pkg/webexposure/findings/findings.json")


def main():
    print("Removing CVE/weaknesses data from findings with cve_applicable=false...")
    print()

    # Load findings
    if not FINDINGS_FILE.exists():
        print(f"Error: {FINDINGS_FILE} not found")
        return 1

    with open(FINDINGS_FILE, 'r') as f:
        findings = json.load(f)

    total_findings = len(findings)
    removed_cve = 0
    removed_weaknesses = 0
    skipped = 0

    print(f"Total findings: {total_findings}")
    print()

    # Process each finding
    for slug, finding in findings.items():
        security = finding.get('security', {})
        cve_applicable = security.get('cve_applicable')

        # Only process findings with cve_applicable=false
        if cve_applicable is not False:
            continue

        # Check if CVE data exists
        had_cve = 'cve' in security
        had_weaknesses = 'weaknesses' in security

        if not had_cve and not had_weaknesses:
            skipped += 1
            continue

        # Remove CVE data
        if had_cve:
            del security['cve']
            removed_cve += 1
            print(f"✓ {slug} - Removed CVE data")

        # Remove weaknesses data
        if had_weaknesses:
            del security['weaknesses']
            removed_weaknesses += 1
            print(f"  └─ Also removed weaknesses data")

    print()
    print("=" * 70)
    print(f"Removed CVE data from: {removed_cve} findings")
    print(f"Removed weaknesses data from: {removed_weaknesses} findings")
    print(f"Already clean: {skipped} findings")
    print()

    # Show what remains in security objects for cve_applicable=false
    false_findings = []
    for slug, finding in findings.items():
        security = finding.get('security', {})
        if security.get('cve_applicable') is False:
            false_findings.append(slug)

    print(f"Findings with cve_applicable=false now only have the flag:")
    print(f"  Total: {len(false_findings)}")
    print()

    # Show example
    if false_findings:
        example_slug = false_findings[0]
        example_security = findings[example_slug]['security']
        print(f"Example ({example_slug}):")
        print(f"  security: {json.dumps(example_security, indent=2)}")
        print()

    if removed_cve > 0 or removed_weaknesses > 0:
        # Write updated findings back to file
        with open(FINDINGS_FILE, 'w') as f:
            json.dump(findings, f, indent=2, ensure_ascii=False)
            f.write('\n')

        print(f"✓ Updated {FINDINGS_FILE}")
    else:
        print("No changes needed - CVE data already clean")

    return 0


if __name__ == '__main__':
    exit(main())
