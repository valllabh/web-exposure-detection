#!/bin/bash

# Test CVE update script with a few findings
# This tests the logic without updating the actual findings.json

set -e

echo "Testing CVE statistics collection..."

# Test products
test_products=("wordpress" "react" "express")

for product in "${test_products[@]}"; do
    echo ""
    echo "Testing: $product"
    echo "----------------------------------------"

    # Query vulnx
    cve_data=$(vulnx search "$product" --json --silent --limit 100 2>/dev/null)

    if [ -z "$cve_data" ]; then
        echo "  No CVEs found"
        continue
    fi

    # Get total from API response
    total=$(echo "$cve_data" | jq -r '.total // 0')

    if [ "$total" -eq 0 ]; then
        echo "  No CVEs found"
        continue
    fi

    # Count by severity from results
    critical=$(echo "$cve_data" | jq '[.results[] | select(.severity == "critical")] | length')
    high=$(echo "$cve_data" | jq '[.results[] | select(.severity == "high")] | length')
    medium=$(echo "$cve_data" | jq '[.results[] | select(.severity == "medium")] | length')
    low=$(echo "$cve_data" | jq '[.results[] | select(.severity == "low")] | length')

    echo "  Total CVEs: $total"
    echo "  Critical: $critical"
    echo "  High: $high"
    echo "  Medium: $medium"
    echo "  Low: $low"

    # Show sample JSON structure with timestamp
    echo ""
    echo "  JSON structure:"
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    jq -n \
        --arg slug "test.$product" \
        --argjson critical "$critical" \
        --argjson high "$high" \
        --argjson medium "$medium" \
        --argjson low "$low" \
        --argjson total "$total" \
        --arg updated "$timestamp" \
        '{
            slug: $slug,
            stats: {
                critical: $critical,
                high: $high,
                medium: $medium,
                low: $low,
                total: $total
            },
            updated: $updated
        }' | jq '.'

    sleep 1
done

echo ""
echo "Test completed successfully!"
