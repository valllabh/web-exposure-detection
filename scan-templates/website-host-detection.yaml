id: website-host-detection
info:
  name: Website Host Detection with Crawlability Check
  author: Vallabh
  severity: info
  description: |
    This template checks if a domain is hosting a real, crawlable website by verifying HTML content and presence of typical web page elements,
    while avoiding default server pages.
  tags: website-host,crawlable,http-server
headless:
  - steps:
      - action: navigate
        args:
          url: "{{BaseURL}}"
      - action: waitload
      - action: waitstable
    matchers:
      - type: regex
        part: body
        regex:
          - "<!DOCTYPE html>"
          - "<html[^>]*>"
          - "<head>.*?</head>"
          - "<a\\s+href=.*?>.*?</a>"
          - "(<a\\s+href=.*?>){5,}"
          - "<meta[^>]+(name|property)=[\"'](description|og:title|og:description|viewport)[\"']"
          - "<link[^>]+rel=[\"']stylesheet[\"']"
          - "<script[^>]+src=\".*?\\.js\""
          # check if page has form or login button
          - "<form[^>]*>"
          - "<input[^>]+type=[\"'](submit|button)[\"']"
          - "<button[^>]*>"
          - "<input[^>]+type=[\"'](text|email|password)[\"']"
          # check for login href
          - "<a[^>]+href=[\"'](login|signin|sign-in|log-in)[\"']"
          - "<a[^>]+href=[\"'](register|signup|sign-up)[\"']"
          - "<a[^>]+href=[\"'](forgot|reset)[\"']"
          - "<a[^>]+href=[\"'](password|pwd)[\"']"
          # http:
          #   - method: GET
          #     path:
          #       - "{{BaseURL}}"

          #     matchers-condition: and
          #     matchers:
          #       - type: word
          #         part: header
          #         words:
          #           - "text/html"

          #       - type: status
          #         status:
          #           - 200

          #       - type: regex
          #         part: body
          #         regex:
          #           - "<!DOCTYPE html>"
          #           - "<html[^>]*>"
          #           - "<head>.*?</head>"
          #           - "<a\\s+href=.*?>.*?</a>"
          #           - "(<a\\s+href=.*?>){5,}"
          #           - "<meta[^>]+(name|property)=[\"'](description|og:title|og:description|viewport)[\"']"
          #           - "<link[^>]+rel=[\"']stylesheet[\"']"
          #           - "<script[^>]+src=\".*?\\.js\""
          #           # check if page has form or login button
          #           - "<form[^>]*>"
          #           - "<input[^>]+type=[\"'](submit|button)[\"']"
          #           - "<button[^>]*>"
          #           - "<input[^>]+type=[\"'](text|email|password)[\"']"
    extractors:
      # Detect authentication mechanisms
      - type: regex
        part: body
        name: auth_forms
        internal: true
        regex:
          - "<form[^>]*>"
          - "<input[^>]+type=[\"'](text|email|password)[\"']"
          - "<input[^>]+name=[\"'](username|user-name|email|user|login)[\"']"
        group: 0

      # Detect SSO and Social Login buttons/links
      - type: regex
        part: body
        name: sso_social
        internal: true
        regex:
          # SSO providers
          - "(?i)(sign|log).{0,5}(in|on).{0,20}(google|microsoft|azure|okta|auth0|onelogin|ping|saml|sso)"
          - "(?i)(oauth|openid|saml|sso)"
          - "(?i)href=[\"'][^\"']*oauth[^\"']*[\"']"
          - "(?i)href=[\"'][^\"']*saml[^\"']*[\"']"
          - "(?i)href=[\"'][^\"']*sso[^\"']*[\"']"
          # Social login providers
          - "(?i)(sign|log).{0,5}(in|on).{0,20}(facebook|twitter|linkedin|github|apple)"
          - "(?i)connect.{0,20}(facebook|google|twitter|linkedin|github|apple)"
          - "(?i)(facebook|google|twitter|linkedin|github|apple).{0,20}(sign|log).{0,5}(in|on)"
          # Social login buttons/icons
          - "(?i)<[^>]*(facebook|google|twitter|linkedin|github|apple)[^>]*>"
          - "(?i)class=[\"'][^\"']*(facebook|google|twitter|linkedin|github|apple|social)[^\"']*[\"']"
        group: 0

      # Detect web technologies from headers and meta tags
      - type: regex
        part: body
        name: tech_stack
        internal: true
        regex:
          # JavaScript frameworks
          - "(?i)(angular|react|vue|next\\.js|nuxt|ember|backbone)"
          - "(?i)<script[^>]*src=[\"'][^\"']*(angular|react|vue|next|nuxt|ember|backbone)[^\"']*[\"']"
          # CSS frameworks
          - "(?i)<link[^>]*href=[\"'][^\"']*(bootstrap|tailwind|bulma|foundation)[^\"']*[\"']"
          # CMS indicators
          - "(?i)(wordpress|drupal|joomla|magento|shopify|wix|squarespace)"
          - "(?i)generator[\"']\\s*content=[\"'][^\"']*(wordpress|drupal|joomla|magento|shopify)[^\"']*[\"']"
          # Authentication systems
          - "(?i)(keycloak|auth0|okta|firebase|cognito)"
        group: 0

      # Extract server information from headers
      - type: kval
        kval:
          - server
          - x-powered-by
          - x-generator
          - x-drupal-cache
          - x-wp-version
        name: server_tech
        internal: true

      # Main extractor combining all findings
      - type: dsl
        dsl:
          - "len(auth_forms) > 0 ? 'Has Forms' : ''"
          - "len(sso_social) > 0 ? 'Has SSO/Social Login' : ''"
          - "join(server_tech, ', ')"
          - "join(tech_stack, ', ')"
